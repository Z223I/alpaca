<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Diagnostic</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        #log { white-space: pre-wrap; border: 1px solid #00ff00; padding: 10px; min-height: 400px; }
        button { padding: 10px; margin: 5px; background: #00ff00; color: #000; border: none; cursor: pointer; }
        button:hover { background: #00cc00; }
    </style>
</head>
<body>
    <h1>WebSocket Diagnostic Tool</h1>
    <div>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    <div id="log"></div>

    <script>
        let ws = null;
        const log = document.getElementById('log');

        function addLog(message) {
            const timestamp = new Date().toISOString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            log.textContent = '';
        }

        function testConnection() {
            addLog('=== Starting WebSocket Connection Test ===');
            addLog(`window.location.hostname = "${window.location.hostname}"`);
            addLog(`window.location.href = "${window.location.href}"`);

            const wsUrl = 'ws://' + (window.location.hostname || 'localhost') + ':8766';
            addLog(`Connecting to: ${wsUrl}`);

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    addLog('‚úÖ WebSocket CONNECTED!');

                    // Test ping
                    addLog('Sending ping...');
                    ws.send(JSON.stringify({ action: 'ping' }));
                };

                ws.onmessage = (event) => {
                    addLog(`üì® Received: ${event.data}`);
                    const data = JSON.parse(event.data);

                    if (data.type === 'pong') {
                        addLog('‚úÖ Ping successful!');
                        // Test health
                        addLog('Sending health check...');
                        ws.send(JSON.stringify({ action: 'health' }));
                    } else if (data.type === 'health') {
                        addLog(`‚úÖ Health check successful!`);
                        addLog(`   Alpaca connected: ${data.alpaca_connected}`);
                        addLog(`   Active symbols: ${data.active_symbols.join(', ') || 'none'}`);
                        addLog(`   Total clients: ${data.total_clients}`);

                        // Test subscription
                        addLog('Subscribing to AAPL...');
                        ws.send(JSON.stringify({ action: 'subscribe', symbol: 'AAPL' }));
                    } else if (data.type === 'subscribed') {
                        addLog(`‚úÖ Subscription successful: ${data.symbol}`);
                        addLog('Waiting for trades...');
                    } else if (data.type === 'trade') {
                        addLog(`üìä TRADE: ${data.symbol} @ $${data.data.price} x ${data.data.size}`);
                    }
                };

                ws.onerror = (error) => {
                    addLog(`‚ùå WebSocket ERROR: ${error}`);
                    addLog(`   Error object: ${JSON.stringify(error)}`);
                };

                ws.onclose = (event) => {
                    addLog(`üîå WebSocket CLOSED`);
                    addLog(`   Code: ${event.code}`);
                    addLog(`   Reason: ${event.reason || 'none'}`);
                    addLog(`   Was clean: ${event.wasClean}`);
                };

            } catch (error) {
                addLog(`‚ùå Exception creating WebSocket: ${error}`);
                addLog(`   Stack: ${error.stack}`);
            }
        }

        // Auto-start test on page load
        addLog('Page loaded. Click "Test Connection" button to begin.');
        addLog(`Browser: ${navigator.userAgent}`);
    </script>
</body>
</html>
