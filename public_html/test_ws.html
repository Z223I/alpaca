<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Diagnostic</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        #log { white-space: pre-wrap; border: 1px solid #00ff00; padding: 10px; min-height: 400px; max-height: 600px; overflow-y: auto; }
        button { padding: 10px; margin: 5px; background: #00ff00; color: #000; border: none; cursor: pointer; }
        button:hover { background: #00cc00; }
        button:disabled { background: #666; color: #999; cursor: not-allowed; }
        input { padding: 8px; margin: 5px; background: #333; color: #00ff00; border: 1px solid #00ff00; font-family: monospace; }
        .controls { margin: 10px 0; padding: 10px; border: 1px solid #444; }
        .controls label { margin-right: 10px; }
        #subscribed-list { color: #ffff00; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>WebSocket Diagnostic Tool</h1>

    <div class="controls">
        <strong>Connection:</strong>
        <button id="btn-connect" onclick="connect()">Connect</button>
        <button id="btn-disconnect" onclick="disconnect()" disabled>Disconnect</button>
        <button onclick="sendPing()">Ping</button>
        <button onclick="sendHealth()">Health Check</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="controls">
        <strong>Subscriptions:</strong>
        <label>Symbol: <input type="text" id="symbol-input" value="AAPL" placeholder="e.g. AAPL" /></label>
        <button id="btn-subscribe" onclick="subscribe()" disabled>Subscribe</button>
        <button id="btn-unsubscribe" onclick="unsubscribe()" disabled>Unsubscribe</button>
        <div id="subscribed-list">Subscribed: (none)</div>
    </div>

    <div id="log"></div>

    <script>
        let ws = null;
        const log = document.getElementById('log');
        const subscribedSymbols = new Set();

        function addLog(message) {
            const timestamp = new Date().toISOString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            log.textContent = '';
        }

        function updateButtons() {
            const connected = ws && ws.readyState === WebSocket.OPEN;
            document.getElementById('btn-connect').disabled = connected;
            document.getElementById('btn-disconnect').disabled = !connected;
            document.getElementById('btn-subscribe').disabled = !connected;
            document.getElementById('btn-unsubscribe').disabled = !connected;
        }

        function updateSubscribedList() {
            const listEl = document.getElementById('subscribed-list');
            if (subscribedSymbols.size === 0) {
                listEl.textContent = 'Subscribed: (none)';
            } else {
                listEl.textContent = 'Subscribed: ' + Array.from(subscribedSymbols).join(', ');
            }
        }

        function connect() {
            addLog('=== Starting WebSocket Connection ===');
            addLog(`window.location.hostname = "${window.location.hostname}"`);

            const wsUrl = 'ws://' + (window.location.hostname || 'localhost') + ':8765';
            addLog(`Connecting to: ${wsUrl}`);

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    addLog('‚úÖ WebSocket CONNECTED!');
                    updateButtons();
                };

                ws.onmessage = (event) => {
                    addLog(`üì® Received: ${event.data}`);
                    try {
                        const data = JSON.parse(event.data);

                        if (data.type === 'pong') {
                            addLog('‚úÖ Pong received - connection alive');
                        } else if (data.type === 'health') {
                            addLog(`‚úÖ Health check response:`);
                            addLog(`   Alpaca connected: ${data.alpaca_connected}`);
                            addLog(`   Active symbols: ${data.active_symbols.join(', ') || 'none'}`);
                            addLog(`   Total clients: ${data.total_clients}`);
                        } else if (data.type === 'connecting') {
                            addLog(`‚è≥ Connecting: ${data.message}`);
                        } else if (data.type === 'subscribed') {
                            addLog(`‚úÖ Subscribed to: ${data.symbol}`);
                            subscribedSymbols.add(data.symbol);
                            updateSubscribedList();
                        } else if (data.type === 'unsubscribed') {
                            addLog(`‚úÖ Unsubscribed from: ${data.symbol}`);
                            subscribedSymbols.delete(data.symbol);
                            updateSubscribedList();
                        } else if (data.type === 'trade') {
                            addLog(`üìä TRADE: ${data.symbol} @ $${data.data.price} x ${data.data.size}`);
                        }
                    } catch (e) {
                        addLog(`‚ö†Ô∏è Could not parse message: ${e}`);
                    }
                };

                ws.onerror = (error) => {
                    addLog(`‚ùå WebSocket ERROR: ${error}`);
                    updateButtons();
                };

                ws.onclose = (event) => {
                    addLog(`üîå WebSocket CLOSED`);
                    addLog(`   Code: ${event.code}`);
                    addLog(`   Reason: ${event.reason || 'none'}`);
                    addLog(`   Was clean: ${event.wasClean}`);
                    subscribedSymbols.clear();
                    updateSubscribedList();
                    updateButtons();
                };

            } catch (error) {
                addLog(`‚ùå Exception creating WebSocket: ${error}`);
                addLog(`   Stack: ${error.stack}`);
            }
        }

        function disconnect() {
            if (ws) {
                addLog('=== Closing WebSocket Connection ===');
                ws.close();
            }
        }

        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('Sending ping...');
                ws.send(JSON.stringify({ action: 'ping' }));
            } else {
                addLog('‚ùå Not connected');
            }
        }

        function sendHealth() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('Sending health check...');
                ws.send(JSON.stringify({ action: 'health' }));
            } else {
                addLog('‚ùå Not connected');
            }
        }

        function subscribe() {
            const symbol = document.getElementById('symbol-input').value.trim().toUpperCase();
            if (!symbol) {
                addLog('‚ùå Please enter a symbol');
                return;
            }
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog(`Subscribing to ${symbol}...`);
                ws.send(JSON.stringify({ action: 'subscribe', symbol: symbol }));
            } else {
                addLog('‚ùå Not connected');
            }
        }

        function unsubscribe() {
            const symbol = document.getElementById('symbol-input').value.trim().toUpperCase();
            if (!symbol) {
                addLog('‚ùå Please enter a symbol');
                return;
            }
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog(`Unsubscribing from ${symbol}...`);
                ws.send(JSON.stringify({ action: 'unsubscribe', symbol: symbol }));
            } else {
                addLog('‚ùå Not connected');
            }
        }

        // Initialize on page load
        addLog('Page loaded. Click "Connect" to begin.');
        addLog(`Browser: ${navigator.userAgent}`);
        updateButtons();
    </script>
</body>
</html>
